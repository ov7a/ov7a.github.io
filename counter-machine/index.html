<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
  <title>Counter machine</title>
  <style>
  body {
    display:grid;
    grid-template-columns:1fr 1fr;
    margin:0;
    text-align:center;
  }
  header {
    grid-column:1/3;
    padding:1rem;
  }
  @media(max-width:700px){
    body { grid-template-columns:1fr; }
    header { grid-column:1; }
  }
  div { padding:1rem; }
  ol {
    padding-left: 1.2em;
    margin-left: 0;
    list-style-position: inside;
  }
</style>
</head>
<body>
  <header>
    <h3>Counter machine</h3>
    <p>An implementation of a minimal <a href="https://en.wikipedia.org/wiki/Counter_machine">counter machine</a>.</p>
    <details>
      <summary>Manual and instructions</summary>
      <p>This machine has two instructions:</p>
      <ol>
        <li><code>INC a</code>, which increments counter number <code>a</code>. Written as <code>+2</code>.</li>
        <li><code>JZDEC a i</code>, which decrements counter number <code>a</code> if it's nonzero, and jumps to instruction <code>i</code> otherwise. Written as <code>-2?5</code>.</li>
      </ol>
    </details>
    <p>Source code on <a href="https://github.com/ov7a/counter-machine">GitHub</a>.</p>
  </header>
  <div class="left">
    <p>Input:</label></p>
    <textarea id="input">
+0
+2
+4
+4
+3
-0?9
+3
-5?2
+1</textarea>
  </div>
  <div class="right">
    <p><button id="run">Run</button></p>
    <p>Output:</p>
    <textarea id="output" readonly autocomplete="off" cols="65"></textarea>
  </div>
<script type="module">
  import { WASI, useStdio } from "https://esm.sh/uwasi@1.4.1";

const inputEl = document.getElementById("input");
const outputEl = document.getElementById("output");
const runBtn = document.getElementById("run");

function autoResize() { // that's ridiculous to have in 2025, tbh
  this.style.height = "";
  this.style.height = this.scrollHeight + "px";
}

inputEl.oninput = autoResize;
outputEl.onchange = autoResize;
autoResize.call(inputEl);

const resp = await fetch("main.wasm");
const bytes = await resp.arrayBuffer();
const module = await WebAssembly.compile(bytes);

runBtn.addEventListener("click", async () => {
  const wasi = new WASI({
    features: [useStdio({
      stdin: () => inputEl.value + "\n\n", // two new lines to avoid a bug with circular stdin
      stdout: (str) => outputEl.value += str,
      stderr: (str) => outputEl.value += str,
    })],
  });
  const instance = await WebAssembly.instantiate(module, {
    wasi_snapshot_preview1: wasi.wasiImport,
  });
  outputEl.value = '';
  wasi.start(instance);
  autoResize.call(outputEl);
});
</script>
</body>
</html>

