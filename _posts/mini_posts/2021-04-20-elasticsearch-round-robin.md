---
layout: post
title: Балансировка в клиенте Elasticsearch
tags: [elasticsearch]
---
Выбор сервера осуществляется по round robin.
Если выбранный сервер не ответил, то он [кладется в бан-лист на минуту](https://github.com/elastic/elasticsearch/blob/master/client/rest/src/main/java/org/elasticsearch/client/RestClient.java#L512), если при следующем запросе не ответил еще раз — примерно на полторы, с увеличением интервала в `2^(failedAttempts/2)` раз [вплоть до 30 минут](https://github.com/elastic/elasticsearch/blob/master/client/rest/src/main/java/org/elasticsearch/client/DeadHostState.java#L60).
Если сервер ответил, то он исключается из черного списка.
Если живых серверов нет, то пробуем самый недавний из черного списка: если и он не отвечает, то все плохо и кидаем исключение.

Напоминает опрос узлов в краулере на старой работе, хотя там реализация была сложнее (хотя бы потому, что проверять надо было как сами сервера, так и прокси), сброс меток был сделан через сброс всего пула, и состояние шарилось между инстансами. Приятно думать, что это было более-менее адекватное решение.

