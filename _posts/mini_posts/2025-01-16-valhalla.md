---
layout: post
title: Valhalla для примитивов
tags: [java, types]
tg_id: 584
---
Хороший [доклад](https://youtu.be/eL1yyTwu4hc) про статус проекта Valhalla, который сможет устранить проблемы, связанные с разделением на объекты и примитивы и сопутствующими оптимизациями (хранить данные на стеке).

В начале идет история примитивов, как и почему они появились, зачем нужен `int`, когда есть `Integer`, а также признаются ранние ошибки первых версий Java. Потом собственно рассказ о том, что с этим можно сделать — и тут всплывают и иммутабельность, и ["прозрачные" типы](/2022/05/19/value-classes.html), и null-безопасность, и потокобезопасность, и оптимизации в памяти всякие, и проблема частичной инициализации, и т.д. — то, что обычно рассказывают в каком-нибудь модном ФП языке. Представляю горящие пердаки некоторых джавистов, которые с пеной у рта доказывали что котлин не нужон с этой его проверкой на null и иммутабельностью. 

Была веселая история про то, что в первых версиях Java примитивный `long` был потоконебезопасен (sic!). Эта история снова может стать актуальной для value-типов на стеке (если они больше машинного слова). Выход — делать все иммутабельно.

История про проблемы с null напоминает историю Kotlin и его платформенными типами (уж не знаю, что хуже, ссылаться на [свою статью на хабре](https://habr.com/ru/companies/inforion/articles/278169/) или ее [репост в бложике](/2016/02/29/habr-how-to-shoot-yourself-in-a-leg-with-kotlin.html#java)), и типичные проблемы с null-безопасностью — а что будет с массивом значений и т.п. В итоге есть план сделать явное обозначение а-ля `Integer?`/`Integer!`.

Увы, обратная совместимость многому препятствует. Нельзя сделать все не-nullable по умолчанию, `Integer!` и `int` не получится сделать на 100% синонимами, сериализация вставляет палки в колеса. Есть риск, что Java может превратиться в плюсы с точки зрения синтаксиса (\*флешбеки от того, как в C++ записываются лямбды\*). Ну и с дженериками еще не все вопросы решены.

В целом выглядит как движение в сторону прогресса, правда очень медленное. Все это продирается через [пик сложности](/2024/12/03/complexity.html) — проект начался аж 2014 году. Правильная модель — ключ к успеху, но ее поиски занимают много времени. Слайд с рассмотренными концептами на 44:05 впечатляет. Если отказаться от некоторых «степеней свободы», то куча сложности просто уходит.

