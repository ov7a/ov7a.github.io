---
layout: post
title: Переиндексация данных в Elasticsearch
tags: [elasticsearch]
---
Как переиндексировать документы, например из-за смены типа поля, желательно "на живую"? На мой взгляд, неплохой вариант выглядит примерно так:
1. Создать новый индекс, переиндексировать туда данные по запросу "все, что было проиндексировано раньше текущего времени".
2. За время переиндексации появятся новые документы — можно повторить эту процедуру, сокращая "лаг" до приемлемого количества. Обычно 2-3 подходов хватает, но это легко автоматизируется.
3. Переключаем альяс со старого индекса на новый.
4. Делаем еще одну итерацию по переиндексации, чтобы переиндексировать оставшиеся документы из старого индекса.
5. Удалить старый индекс.

Такой подход может показаться сложным, но зато в приложении, читающем данные, разница будет практически не видна и эквивалента тому, что немного документов из п.4 были проиндексированы чуть позже. Если данных много, то это обычно не критично.

Но что делать, если в индексе нет даты индексации? И никакого поля, которое можно было бы использовать таким образом? Есть альтернативный подход:
1. Создать новый индекс.
2. Переключить на него альяс для записи — все новые документы попадают теперь туда.
3. Сделать реиндекс. Поскольку в старый индекс уже ничего не пишется, никаких запросов не нужно, все делается за 1 раз.
4. Переключить альяс для чтения на новый индекс.
5. Удалить старый индекс.

Звучит попроще, но для читающего приложения такая ситуация будет выглядеть, как будто индексация прекратилась на существенный период времени, а потом резко продолжилась с мгновенным появлением документов из этого периода. В принципе, тоже жизнеспособный вариант, подходит для кейсов, когда можно обрабатывать данные с большой задержкой (какие-нибудь ежемесячные отчеты или подобная штука).

Внимательный читатель заметит, что рассмотрен только простейший случай, когда есть только производитель и потребитель, и никаких обновлений. Что ж, когда приложение сложно обновляет документы — тут уже думать надо, шансы прикидывать...

