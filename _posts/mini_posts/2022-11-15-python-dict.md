---
layout: post
title: Порядок ключей в словаре в питоне
tags: [python, algorithms]
tg_id: 351
---
В Python 3.6 [была оптимизирована](https://docs.python.org/3/whatsnew/3.6.html#new-dict-implementation) память, используемая `dict`. 
Раньше элементы [хранились в массиве](https://mail.python.org/pipermail/python-dev/2012-December/123028.html), каждый элемент — структура из хэша и ссылок на ключ и на значение. Поскольку используется открытая адресация, то многие ячейки были пусты и прорва памяти тратилась зря.
В новой реализации в основном массиве хранится только индекс, а хэши и указатели хранятся в отдельном списке. За счет этого размер заполненной и пустой ячейки будут одинаковыми, а список с полезной нагрузкой почти всегда плотно заполненным (при удалении там остается заглушка, чтобы список за линейное время не двигать). 

Один из побочных эффектов — ключи становятся упорядочены в порядке добавления (в 3.7 это закрепили на уровне требования). С одной стороны — прикольно, но с другой, когда читаешь код, который на это полагается, то так можно и с ума начать сходить ("почему в хэш-таблице ключи отсортированы?!"). Для читаемости лучше все-таки явно [OrderedDict](https://docs.python.org/3/library/collections.html#collections.OrderedDict) использовать.
