---
layout: post
title: "Как ls и grep понимают, что их вывод перенаправлен?"
tags: [linux, cli]
tg_id: 684
---
Если вы пользуетесь консолью, то могли заменить, что обычный вывод стандартных утилит обычно цветной, но если его перенаправить через конвейер `|`, то цвет "теряется". Работает это [очень просто](https://github.com/coreutils/coreutils/blob/cd52292221adaff8cf67299106d78007b8fa8616/src/ls.c#L2172): через библиотечный вызов [`isatty`](https://man7.org/linux/man-pages/man3/isatty.3.html) определяется, является ли `stdout` терминалом или нет. Еще дополнительно проверяется через переменные среды, что терминал не совсем урезанный и поддерживает цвет.

А как работает `isatty`? [Делает системный вызов](https://stackoverflow.com/questions/56419346/how-does-the-libc-function-isatty-work) `ioctl` с такими параметрами, которые сработают только в терминале, т.е. если вызов вернул ошибку, то устройство — не терминал. Эдакий `try`-`catch` :)
