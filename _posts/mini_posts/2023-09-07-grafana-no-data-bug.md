---
layout: post
title: No data в Grafana
tags: [мониторинг]
---
Некоторое время назад наткнулся на довольно противный [баг](https://github.com/grafana/grafana/issues/43862) в графане: добавил дашборд, вижу данные, потом меняю интервал на более продолжительный... и графики исчезают, вместо них вижу "No data".

Сначала грешил на комбинацию [нестандарного способа запихивания данных](/2023/07/11/prometheus-store.html) и кэширование, с которым вроде не все так просто в этом Mimir (ссылки потерял, поверьте, вы все равно не хотите это знать). Но реальность оказалась [еще хуже](https://github.com/grafana/grafana/issues/43862): все данные на месте, просто... не запрашиваются. 

Количество точек в запросе для отображения графика зависит от размера окна (sic!). Если быть точнее, то [от ширины панели](https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/#query-options). При запросе к Prometheus [вычисляются значения](https://stackoverflow.com/a/73921856/1003491) для точек `start`, `start+interval`, `start+2*interval`, ... `end`. `interval` — это период времени, деленный на количество точек. Если значения для какой-то точки нет, то Prometheus [возвращает самое новое значение из предыдущих](https://prometheus.io/docs/prometheus/latest/querying/basics/#staleness), но только если оно не старше какого-то периода (иначе метрика считается без данных, если она не обновлялась). У меня метрики отсылались 3 раза в день, вот и получалось, что данные просто "не находились". Я это полечил костылем, выставив `Max data points = 11000` (больше [нельзя](https://github.com/prometheus/prometheus/issues/2253)) и `Min interval = 30m` [в настройках запроса](https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/#query-options).

Вроде как у каждого шага есть обоснование, почему это должно быть так, и в типичном сценарии, когда метрики опрашиваются каждые 5 секунд, все будет работать из коробки, но епрст... Мне даже официальная поддержка ответила копипастой [отсюда](https://rusche.me/blog/grafana-data-points/), официального и подробного туториала я по этой теме не смог быстро найти. И вообще, совсем не ожидал, что так сложно будет нарисовать график по точкам...
