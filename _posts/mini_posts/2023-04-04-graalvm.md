---
layout: post
title: GraalVM
tags: [graalvm, java]
tg_id: 392
---
Наконец-то дошли руки попробовать компиляцию в нативный код (aka AOT compilation) от GraalVM. 

Написал Hello World на java, выбрал GraalVM в качестве JVM, подключил [официальный плагин](https://graalvm.github.io/native-build-tools/latest/gradle-plugin.html#_introduction) Gradle, запустил `nativeCompile` и... все, оно скомплировалось и работает. Без ошибок, без разбора какой-то дичи, просто заработало сразу и все. Минут 15 на все про все ушло. 

Ладно, попробуем что-нибудь поинтереснее — схавает ли GraalVM Spring с его рефлексией и прокси-классами в рантайме? Создаем простенький контроллер, теперь уже на Kotlin, который выплевывает JSON. Компилируем и... оно тоже работает! о_О

Я просто в шоке, до чего дошел прогресс. Ожидал веселых или не очень потрахушек примерно как с [Kotlin native](/2020/10/01/kotlin-native.html) или с [KotlinJS](/2021/10/06/kotlin-js.html), но испытал преимущественно позитивные эмоции. Справедливости ради, на большом проекте все-таки магия сломалась:
```
Caused by: com.oracle.graal.pointsto.constraints.UnsupportedFeatureException: No instances of CensoredLoggerContext are allowed in the image heap as this class should be initialized at image runtime.
```
Возможно, еще вернусь к подобным экспериментам в будущем, интересно на перф-тесты всего этого посмотреть.

Единственная проблемка, которая возникла — нужно корректно выставлять `JAVA_HOME` при компиляции. Кроме этого отмечу, что компиляция довольно долгая (1 контроллер на спринге компилировался аж 2 минуты). Разумеется, больше получается конечный файл — 73 Мб (при этом fat jar занимает 22 Мб), но с учетом того, что сама JVM занимает больше 200 Мб, это фигня.
