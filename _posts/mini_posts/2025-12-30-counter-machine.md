---
layout: post
title: Счетчиковая машина
tags: [algorithms, math, c, wasm]
tg_id: 688
---
На курсе по алгоритмам в основном использовали RAM-машину в качестве алгоритмической модели. У нее есть много вариаций с меньшим числом операций, и одна из них — [счетчиковая машина](https://en.wikipedia.org/wiki/Counter_machine), где один из вариантов имеет всего две операции: инкремент и декремент с условным переходом (хотя можно и до [одной](https://en.wikipedia.org/wiki/One-instruction_set_computer) ужать, [Тьюринг-полнота почти везде](/2023/02/07/turing-completeness.html)).

Мне хотелось накодить что-нибудь простенькое и [я сделяль](/counter-machine/).

Если нечем заняться на каникулах, поиграйтесь и попробуйте найти самую короткую программу, которая в нулевом счетчике выставит 2026 (ура, Новый Год), а остальные оставит пустыми, с минимальным использованием дополнительных счетчиков. Это хорошая разминка для ума и особенно для тренировки отлова ошибок типа off-by-one. Можно написать скрипт, который напишет программу за вас. Можно заставить это делать ИИ-агента. ChatGPT, например, в думающем режиме мне доказал, что оптимальное решение — это 2026 инкрементов. А вот Gemini с первого раза бахнул [программу](https://github.com/ov7a/counter-machine/blob/main/examples/2026_factorization.txt) на 29 инструкций и 7 счетчиков, что было круче моего рабочего [варианта](https://github.com/ov7a/counter-machine/blob/main/examples/2026_multiplication.txt) на 34 инструкции. Усердно попыхтев, к счастью, нашел [вариант](https://github.com/ov7a/counter-machine/blob/main/examples/2026_magic.txt) за 26 инструкций и 6 счетчиков (память надо сейчас беречь). Фух, пока еще не совсем отупел.

Код [писал](/gags/#2020-10-07-cpp-after-long-break.png) на чистом Си, узнал про [ungetc](https://en.cppreference.com/w/c/io/ungetc) и что [scanf тупой](https://github.com/ov7a/counter-machine/blob/8dce65979200bad765f1f2910f4e8e754f5046c4/main.c#L98).

Разумеется, больше всего времени отняло все что угодно, кроме основной логики. Поддержка WASM в браузере сильно разочаровала. Вроде простая задача, запустить нативный код в браузере, еще 5 лет назад [такое делал с растом](/2021/02/03/rust.html), должно же быть уже все элементарно, да? \*падме.jpg\*

Спрашивал ChatGPT, попробовал [wasmer](https://github.com/wasmerio/wasmer-js) и [bjorn3](https://github.com/bjorn3/browser_wasi_shim) — тупо не работают и даже ошибки не выводят, [Emscripten](https://emscripten.org/) показался слишком старым (эй, ну браузере-то надо модно и молодежно!), а [jco](https://github.com/bytecodealliance/jco) нужна была промежуточная траспиляция. ChatGPT еще и выдавал какую-то хрень в примерах кода.

В итоге сам нашел хоть что-то рабочее — [uWASI](https://github.com/swiftwasm/uwasi). Через гугл, прости господи. Сам прочитал Readme, потому что у гпт лапки и он не смог сгенерировать рабочий код, сам написал как надо. Был баг, что `stdin` читался по кругу — вставил костыль.

Вот такие пироги. С наступающим!
