---
layout: post
title: Пулл-реквест в Kotlin
tags: [kotlin]
---
[Пара](/2021/08/03/kotlin-compiler.html) недавних [постов](/2021/08/31/kotlin-pull-request.html) были подводкой к этому (и еще один грядет). Захотел сделать пулл-реквест в Kotlin, выбрал один из "простых" тикетов. Выкачал репозиторий с GitHub, импортировал в Idea и начались проблемы.

Для регресса нужна установка Java 6. В Readme рекомендуют пакетные менеджеры, аж 3 штуки, но все они устанавливаются только через `curl | sh`, что [опять](/2021/02/03/rust.html) меня триггернуло. Заленился искать адекватный вариант, в итоге просто отключил флагом gradle.

Попробовал запустить тесты. Один тест не запустился — оказалось, что надо было сначала сгенерировать все тесты, а потом уже запускать `compilerTest`. Кстати, хрен найдешь этот таск в списке грейдловских. Сгенерированные тесты не прошли, работало больше 2 часов, завершения тестов javascript я так и не дождался. В завалившихся, кроме javascript, были еще тесты с Java 9-15, но даже если запуститься с Java 15, ситуация не изменилась. Причем в репозитории лежит `.idea`-проект, т.е. подразумевается, что все уже настроено, а по факту — даже просто прогнать тесты уже не так просто, причем проблема [не только у меня](https://discuss.kotlinlang.org/t/building-kotlin-on-windows/1394), а может это и вовсе [норма](https://teamcity.jetbrains.com/project.html?tab=projectOverview&projectId=Kotlin).

Сам проект выглядит не очень ухоженным. Открытых тикетов больше 4 тысяч, веток 3,5 тысячи, TODO в коде 9 тысяч, некоторые пулл-реквесты висят с 2017 года ([бывают и просто грустные](https://github.com/JetBrains/kotlin/pull/1710)). В коде встречаются непонятные сокращения, периодически выскакивают java-файлы, форматирование и нейминг неконсистентные, есть даже файлы, названные по идентификатору тикетов в YouTrack. Создается впечатление, что раньше Kotlin был прибит гвоздями к Idea, потому что плагин был в основном коде языка и добавление инспекции могло привести к изменению языка (судя по истории git). Структура проекта вроде понятна, но найти место, где нужно поменять код, не очень тривиально (хотя это скорее я просто затупил). У меня возникло подозрение, что есть код, вообще не покрытый тестами, ну или я их просто не смог найти. У некоторых тестов интересный формат входных данных: котлиновский файл с кучей комментариев для управления проверками (но документации нет).

Выбранный [тикет](https://youtrack.jetbrains.com/issue/KT-11970) так и не получилось сделать: сначала я долго не понимал, что именно там нужно сделать и где, а потом пришел к выводу, что не факт, что эти изменения вообще нужны. Даже совсем плюнуть хотел на эту затею, но потом вспомнил о [баге с манифестом](/2020/10/20/kotlin-manifest.html). В нем хотя бы было понятно, что делать и откуда начать. Корневая причина оказалась не там, где я думал, но в итоге со всем разобрался (хотя тесты чужеродно выглядят). [Мой пулл-реквест](https://github.com/JetBrains/kotlin/pull/4546) в итоге приняли (achievement unlocked!), но ревьюер проделал больше работы, чем я: я упустил довольно серьезный баг, поэтому не очень собой доволен. А еще TeamCity шлет письма по [валящимся билдам](https://teamcity.jetbrains.com/viewLog.html?buildId=3593638&buildTypeId=Kotlin_KotlinForGoogle_JVMCompilerTests_LINUX&tab=buildResultsDiv), в которые попал мой коммит (хорошо хоть проблемы вызваны не моими изменениями).

